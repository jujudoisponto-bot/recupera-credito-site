<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Recupera Crédito</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1323;color:#e2e8f0}
    .grad{background:linear-gradient(135deg,#e11d48,#f97316)}
  </style>
</head>
<body class="min-h-screen">

  <!-- Cabeçalho -->
  <header class="sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-white/5">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="h-8 w-8 rounded-lg grad block"></span>
        <div class="font-black tracking-tight">RECUPERA <span class="text-rose-500">CRÉDITO</span> — Admin</div>
      </div>
      <button id="btn-sair" class="hidden text-sm px-3 py-1 border rounded hover:bg-white/10">Sair</button>
    </div>
  </header>

  <div class="max-w-6xl mx-auto p-4">
    <!-- Login -->
    <div id="login" class="bg-white/5 rounded-xl border border-white/10 p-6 max-w-md mx-auto mt-10">
      <h2 class="font-bold mb-2 text-lg text-center">Acesso restrito</h2>
      <form id="form-login" class="space-y-3">
        <input name="user" placeholder="Usuário" class="w-full bg-transparent border border-white/20 rounded px-3 py-2 text-white" value="ADMIN">
        <input name="pass" placeholder="Senha" class="w-full bg-transparent border border-white/20 rounded px-3 py-2 text-white" type="password" value="recupera123">
        <button class="w-full grad text-white rounded px-3 py-2 font-bold">Entrar</button>
      </form>
      <p class="text-xs text-slate-400 mt-2 text-center">Login: <b>ADMIN</b> — Senha: <b>recupera123</b></p>
    </div>

    <!-- App -->
    <div id="app" class="hidden mt-8">
      <h2 class="text-xl font-bold mb-3">Leads recebidos</h2>
      <div class="overflow-x-auto bg-white/5 border border-white/10 rounded-xl">
        <table class="w-full text-sm">
          <thead class="bg-black/30 text-slate-300">
            <tr>
              <th class="text-left p-2">Quando</th>
              <th class="text-left p-2">Tipo</th>
              <th class="text-left p-2">Nome</th>
              <th class="text-left p-2">WhatsApp</th>
              <th class="text-left p-2">Cidade</th>
              <th class="text-left p-2">Tempo</th>
              <th class="text-left p-2">Limite</th>
              <th class="text-left p-2">Status</th>
              <th class="text-left p-2">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody" class="text-slate-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const loginBox = document.getElementById('login');
    const appBox = document.getElementById('app');
    const btnSair = document.getElementById('btn-sair');
    const tbody = document.getElementById('tbody');
    const WPP = '55SEUNUMEROAQUI'; // troque pelo seu número real

    function dt(s){ return new Date(s).toLocaleString('pt-BR'); }

    async function loadLeads(){
      const r = await fetch('/api/leads');
      if(!r.ok){
        loginBox.classList.remove('hidden');
        appBox.classList.add('hidden');
        btnSair.classList.add('hidden');
        return;
      }
      const rows = await r.json();
      tbody.innerHTML = rows.map(x=>`
        <tr class="border-t border-white/10">
          <td class="p-2">${dt(x.created_at)}</td>
          <td class="p-2">${x.tipo}</td>
          <td class="p-2">${x.nome||'-'}</td>
          <td class="p-2">${x.whatsapp||'-'}</td>
          <td class="p-2">${x.cidade||'-'}</td>
          <td class="p-2">${x.tempo||'-'}</td>
          <td class="p-2">${x.limite||'-'}</td>
          <td class="p-2">
            <select data-id="${x.id}" class="status bg-transparent border border-white/20 rounded px-2 py-1 text-slate-200">
              ${['Novo','Em contato','Qualificado','Fechado','Descartado']
                .map(s=>`<option ${s===x.status?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td class="p-2">
            <a target="_blank" class="text-rose-400 underline" href="https://wa.me/${WPP}?text=${encodeURIComponent('Olá '+(x.nome||'')+', recebi sua análise da Recupera Crédito. Podemos falar agora?')}">WhatsApp</a>
          </td>
        </tr>
      `).join('');
    }

    document.getElementById('form-login').addEventListener('submit', async e=>{
      e.preventDefault();
      const d = Object.fromEntries(new FormData(e.target).entries());
      const r = await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
      if(r.ok){
        loginBox.classList.add('hidden');
        appBox.classList.remove('hidden');
        btnSair.classList.remove('hidden');
        loadLeads();
      } else alert('Login inválido');
    });

    btnSair.addEventListener('click', async ()=>{
      await fetch('/logout',{method:'POST'});
      appBox.classList.add('hidden');
      loginBox.classList.remove('hidden');
      btnSair.classList.add('hidden');
    });

    document.addEventListener('change', async e=>{
      if(e.target.classList.contains('status')){
        const id = e.target.dataset.id;
        const status = e.target.value;
        await fetch('/api/leads/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status})});
      }
    });

    loadLeads();
  </script>
</body>
</html>
